{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<style>
    #calendar {
        max-width: 1200px;
        margin: 20px auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        min-height: 600px;
    }
    
    .legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid #ddd;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        font-size: 18px;
    }
    
    .debug-panel {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="text-center mb-4">Календарь технического обслуживания</h1>
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background-color: #007bff;"></div>
            <span>ТО - Технический осмотр</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #fd7e14;"></div>
            <span>ТР - Технический ремонт</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #6f42c1;"></div>
            <span>КР - Капитальный ремонт</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #28a745;"></div>
            <span>Выполнено</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ffc107;"></div>
            <span>В работе</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #dc3545;"></div>
            <span>Отменено</span>
        </div>
    </div>

    <div id="loading" class="loading">
        Загрузка календаря...
    </div>
    
    <div id="calendar"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ru.min.js'></script>

<script>
let calendar;

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== ИНИЦИАЛИЗАЦИЯ КАЛЕНДАРЯ ===');
    
    const calendarEl = document.getElementById('calendar');
    const loadingEl = document.getElementById('loading');
    
    if (!calendarEl) {
        console.error('Элемент calendar не найден!');
        return;
    }
    
    console.log('Элемент calendar найден');
    
    loadingEl.style.display = 'block';
    calendarEl.style.display = 'none';
    
    try {
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ru',
            firstDay: 1,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: 'Сегодня',
                month: 'Месяц',
                week: 'Неделя',
                day: 'День'
            },
            
            events: '/calendar/all/',
            
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                const event = info.event;
                const props = event.extendedProps;
                
                alert(
                    event.title + '\n\n' +
                    'Оборудование: ' + props.equipment + '\n' +
                    'Инвентарный номер: ' + props.inventory_number + '\n' +
                    'Вид обслуживания: ' + props.maintenance_type + '\n' +
                    'Дата: ' + event.start.toLocaleDateString('ru-RU') + '\n' +
                    'Статус: ' + props.status
                );
            },
            
            eventDidMount: function(info) {
                console.log('Событие отрисовано:', info.event.title, 'на', info.event.start.toLocaleDateString('ru-RU'));
                info.el.title = info.event.title + '\nСтатус: ' + info.event.extendedProps.status;
            },
            
            datesSet: function(info) {
                console.log('Текущий период:', info.view.title);
                updateDebugInfo();
            },
            
            loading: function(isLoading) {
                if (isLoading) {
                    console.log('Загрузка календаря...');
                } else {
                    console.log('Календарь загружен');
                    loadingEl.style.display = 'none';
                    calendarEl.style.display = 'block';
                    updateDebugInfo();
                    
                    setTimeout(() => {
                        calendar.updateSize();
                        console.log('Размер календаря обновлен');
                    }, 100);
                }
            }
        });
        
        calendar.render();
        console.log('Календарь отрендерен');
        
        setTimeout(() => {
            updateDebugInfo();
            const events = calendar.getEvents();
            console.log('Проверка после рендера - событий:', events.length);
            
            if (events.length === 0) {
                console.warn('События не загрузились, пробуем refetch...');
                calendar.refetchEvents();
            }
        }, 2000);
        
    } catch (error) {
        console.error('Ошибка инициализации календаря:', error);
        loadingEl.innerHTML = 'Ошибка инициализации календаря: ' + error.message;
    }
});

function checkEvents() {
    if (!calendar) {
        alert('Календарь не инициализирован');
        return;
    }
    
    const events = calendar.getEvents();
    const debugInfo = document.getElementById('debug-info');
    
    let html = `<div class="mt-2">
        <strong>Событий в календаре: ${events.length}</strong>`;
    
    if (events.length > 0) {
        html += '<ul class="mt-2">';
        events.slice(0, 5).forEach((event, index) => {
            html += `<li>${event.title} - ${event.start.toLocaleDateString('ru-RU')}</li>`;
        });
        if (events.length > 5) {
            html += `<li>... и еще ${events.length - 5} событий</li>`;
        }
        html += '</ul>';
    } else {
        html += '<p class="text-warning mt-2">Событий нет!</p>';
    }
    
    html += '</div>';
    debugInfo.innerHTML = html;
    
    console.log('=== ПРОВЕРКА СОБЫТИЙ ===');
    console.log('Всего событий:', events.length);
    events.forEach((event, index) => {
        console.log(`${index + 1}. ${event.title} - ${event.start.toLocaleDateString('ru-RU')}`);
    });
}

function loadAllEvents() {
    if (!calendar) return;
    
    console.log('Принудительная загрузка всех событий...');
    calendar.refetchEvents();
    
    setTimeout(checkEvents, 1000);
}

function testEvents() {
    if (!calendar) return;
    
    console.log('Добавление тестовых событий...');
    
    calendar.addEvent({
        title: 'ТЕСТ - Токарный станок - ТО',
        start: '2025-11-15',
        color: '#007bff',
        extendedProps: {
            equipment: 'Токарный станок 1К62',
            maintenance_type: 'Технический осмотр',
            status: 'Запланировано',
            inventory_number: 'TEST-001'
        }
    });
    
    calendar.addEvent({
        title: 'ТЕСТ - Пресс - ТР',
        start: '2025-11-20', 
        color: '#fd7e14',
        extendedProps: {
            equipment: 'Пресс гидравлический',
            maintenance_type: 'Технический ремонт',
            status: 'В работе',
            inventory_number: 'TEST-002'
        }
    });
    
    console.log('Тестовые события добавлены');
    checkEvents();
}

function updateDebugInfo() {
    if (!calendar) return;
    
    const events = calendar.getEvents();
    const debugInfo = document.getElementById('debug-info');
    
    if (debugInfo) {
        debugInfo.innerHTML = `
            <div class="small text-muted">
                Событий: <strong>${events.length}</strong> | 
                Период: <strong>${calendar.view.title}</strong>
            </div>
        `;
    }
}

window.debugCalendar = checkEvents;
window.getCalendar = () => calendar;
</script>
{% endblock %}